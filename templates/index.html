<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êï∞ÊçÆÂ∫ìË°®ÁªìÊûÑËÆæËÆ°Âô®</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üóÉÔ∏è</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.4;
        }
        
        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Â∑•ÂÖ∑Ê†èÊ†∑Âºè */
        .toolbar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }
        
        .toolbar h2 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 1px solid #34495e;
            padding-bottom: 8px;
        }
        
        .tool-item {
            background-color: #34495e;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: move;
            transition: all 0.3s;
            user-select: none;
            display: flex;
            align-items: center;
        }
        
        .tool-item i {
            margin-right: 8px;
        }
        
        .tool-item:hover {
            background-color: #3d566e;
            transform: translateY(-2px);
        }
        
        /* ÁîªÂ∏ÉÂå∫ÂüüÊ†∑Âºè */
        .canvas-container {
            flex: 1;
            position: relative;
            background-color: #ecf0f1;
            overflow: auto;
            padding: 20px;
        }
        
        .canvas {
            position: relative;
            min-height: 100%;
            min-width: 100%;
        }
        
        /* Ë°®ÁªìÊûÑÊ†∑Âºè */
        .table {
            position: absolute;
            width: 280px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            cursor: move;
            z-index: 10;
        }
        
        .table-header {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-actions {
            display: flex;
            gap: 5px;
        }
        
        .table-action-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 2px 5px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        
        .table-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .table-body {
            padding: 8px 0;
        }
        
        .table-row {
            display: flex;
            padding: 6px 15px;
            border-bottom: 1px solid #eee;
            position: relative;
            cursor: pointer;
        }
        
        .table-row:hover {
            background-color: #f9f9f9;
        }
        
        .table-row.selected {
            background-color: #e3f2fd;
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        .field-name {
            flex: 1;
            font-weight: 500;
        }
        
        .field-type {
            color: #7f8c8d;
            font-size: 0.85rem;
            width: 80px;
            text-align: right;
        }
        
        .field-actions {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }
        
        .table-row:hover .field-actions {
            display: flex;
            gap: 5px;
        }
        
        .field-action-btn {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 0.7rem;
            padding: 2px;
            border-radius: 2px;
        }
        
        .field-action-btn:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        /* Â±ûÊÄßÈù¢ÊùøÊ†∑Âºè */
        .properties {
            width: 320px;
            background-color: white;
            border-left: 1px solid #ddd;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .properties h2 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .property-group {
            margin-bottom: 15px;
        }
        
        .property-group h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .property-item {
            margin-bottom: 10px;
        }
        
        .property-item label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }
        
        .property-item input, .property-item select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .property-section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .property-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 8px 0;
        }
        
        .property-section-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
            color: #2c3e50;
            font-size: 0.95rem;
        }
        
        .property-section-header i {
            color: #3498db;
            transition: transform 0.3s ease;
        }
        
        .property-section-header.collapsed i.fa-chevron-down {
            transform: rotate(-90deg);
        }
        
        .property-section-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
            max-height: 1000px;
        }
        
        .property-section-content.collapsed {
            max-height: 0;
        }
        
        /* ËøûÊé•Á∫øÊ†∑Âºè */
        .relationship {
            position: absolute;
            z-index: 5;
            pointer-events: none;
        }
        
        .relationship-line {
            stroke: #e74c3c;
            stroke-width: 2;
        }
        
        /* ÊåâÈíÆÊ†∑Âºè */
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .btn-full {
            width: 100%;
            justify-content: center;
            margin-bottom: 8px;
        }
        
        /* JSONÁºñËæëÂô®Ê†∑Âºè */
        .json-editor, .sql-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }
        
        .json-editor-content, .sql-modal-content {
            background: white;
            width: 90%;
            height: 90%;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .json-editor-header, .sql-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .json-editor-body, .sql-modal-body {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
            background: #f8f9fa;
            color: #24292e;
            overflow: auto;
            white-space: pre-wrap;
        }
        
        .json-editor-textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            resize: none;
            background: transparent;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #24292e;
        }
        
        /* JSONËØ≠Ê≥ïÈ´ò‰∫Æ */
        .json-key {
            color: #d73a49;
            font-weight: bold;
        }
        
        .json-string {
            color: #032f62;
        }
        
        .json-number {
            color: #005cc5;
        }
        
        .json-boolean {
            color: #6f42c1;
        }
        
        .json-null {
            color: #e36209;
        }
        
        .json-bracket {
            color: #24292e;
            font-weight: bold;
        }
        
        .json-colon {
            color: #24292e;
        }
        
        .json-comma {
            color: #24292e;
        }
        
        /* SQLËØ≠Ê≥ïÈ´ò‰∫Æ */
        .sql-keyword {
            color: #d73a49;
            font-weight: bold;
        }
        
        .sql-table {
            color: #6f42c1;
        }
        
        .sql-field {
            color: #005cc5;
        }
        
        .sql-type {
            color: #032f62;
        }
        
        .sql-comment {
            color: #6a737d;
            font-style: italic;
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .toolbar, .properties {
                width: 100%;
                height: auto;
            }
            
            .toolbar {
                order: 2;
            }
            
            .canvas-container {
                order: 1;
                height: 60vh;
            }
            
            .properties {
                order: 3;
                border-left: none;
                border-top: 1px solid #ddd;
            }
        }
        
        /* È°∂ÈÉ®ËèúÂçïÊ†∑Âºè */
        .top-menu {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .top-menu h1 {
            font-size: 1.5rem;
        }
        
        .menu-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Áä∂ÊÄÅÊ†èÊ†∑Âºè */
        .status-bar {
            background-color: #34495e;
            color: white;
            padding: 5px 20px;
            font-size: 0.8rem;
        }
        
        .properties-actions {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .checkbox-item input {
            width: auto;
        }
        
        .checkbox-item label {
            margin-bottom: 0;
            font-size: 0.85rem;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ÈÄöÁü•Ê†∑Âºè */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background-color: #2ecc71;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        .notification.info {
            background-color: #3498db;
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ËèúÂçï -->
    <div class="top-menu">
        <h1><i class="fas fa-database"></i> Êï∞ÊçÆÂ∫ìË°®ÁªìÊûÑËÆæËÆ°Âô®</h1>
        <div class="menu-actions">
            <button class="btn" id="load-tables"><i class="fas fa-sync-alt"></i> Âä†ËΩΩË°®</button>
            <button class="btn btn-success" id="save-table"><i class="fas fa-save"></i> ‰øùÂ≠òË°®</button>
            <button class="btn" id="export-json"><i class="fas fa-file-export"></i> ÂØºÂá∫JSON</button>
            <button class="btn btn-success" id="generate-sql"><i class="fas fa-code"></i> ÁîüÊàêSQL</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Â∑¶‰æßÂ∑•ÂÖ∑Ê†è -->
        <div class="toolbar">
            <h2>Â∑•ÂÖ∑ÁÆ±</h2>
            <div class="tool-item" draggable="true" data-type="table">
                <i class="fas fa-table"></i> Êï∞ÊçÆË°®
            </div>
            <div class="tool-item" id="btn-new-table">
                <i class="fas fa-plus"></i> Êñ∞Âª∫Ë°®
            </div>
            
            <h2 style="margin-top: 30px;">Êìç‰Ωú</h2>
            <div class="tool-item" id="btn-add-field">
                <i class="fas fa-plus-circle"></i> Ê∑ªÂä†Â≠óÊÆµ
            </div>
            <div class="tool-item" id="btn-copy-table">
                <i class="fas fa-copy"></i> Â§çÂà∂Ë°®
            </div>
            <div class="tool-item" id="btn-json-editor">
                <i class="fas fa-code"></i> JSONÁºñËæëÂô®
            </div>
        </div>
        
        <!-- ‰∏≠Èó¥ÁîªÂ∏ÉÂå∫Âüü -->
        <div class="canvas-container">
            <div class="canvas" id="canvas">
                <!-- Ë°®ÁªìÊûÑÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÊ∑ªÂä† -->
            </div>
        </div>
        
        <!-- Âè≥‰æßÂ±ûÊÄßÈù¢Êùø -->
        <div class="properties">
            <h2>Â±ûÊÄßÈù¢Êùø</h2>
            
            <div class="property-section">
                <div class="property-section-header" id="table-properties-header">
                    <h3><i class="fas fa-table"></i> Ë°®Â±ûÊÄß</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="property-section-content" id="table-properties-content">
                    <div class="property-item">
                        <label for="table-name">Ë°®Âêç</label>
                        <input type="text" id="table-name" placeholder="ËæìÂÖ•Ë°®Âêç">
                    </div>
                    <div class="property-item">
                        <label for="table-comment">Ê≥®Èáä</label>
                        <input type="text" id="table-comment" placeholder="Ë°®Ê≥®Èáä">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success btn-full" id="sync-table"><i class="fas fa-cloud-upload-alt"></i> ÂêåÊ≠•Âà∞Êï∞ÊçÆÂ∫ì</button>
                    </div>
                </div>
            </div>
            
            <div class="property-section">
                <div class="property-section-header" id="field-properties-header">
                    <h3><i class="fas fa-list"></i> Â≠óÊÆµÂ±ûÊÄß</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="property-section-content" id="field-properties-content">
                    <div class="property-item">
                        <label for="field-name">Â≠óÊÆµÂêç</label>
                        <input type="text" id="field-name" placeholder="Â≠óÊÆµÂêç">
                    </div>
                    <div class="property-item">
                        <label for="field-type">Êï∞ÊçÆÁ±ªÂûã</label>
                        <select id="field-type">
                            <option value="INTEGER">INTEGER</option>
                            <option value="VARCHAR">VARCHAR</option>
                            <option value="TEXT">TEXT</option>
                            <option value="DATETIME">DATETIME</option>
                            <option value="DATE">DATE</option>
                            <option value="TIME">TIME</option>
                            <option value="BOOLEAN">BOOLEAN</option>
                            <option value="DECIMAL">DECIMAL</option>
                            <option value="FLOAT">FLOAT</option>
                            <option value="DOUBLE">DOUBLE</option>
                            <option value="BLOB">BLOB</option>
                            <option value="JSON">JSON</option>
                        </select>
                    </div>
                    <div class="property-item">
                        <label for="field-length">ÈïøÂ∫¶/ÂÄº</label>
                        <input type="text" id="field-length" placeholder="‰æãÂ¶Ç: 255">
                    </div>
                    <div class="property-item">
                        <label for="field-default">ÈªòËÆ§ÂÄº</label>
                        <input type="text" id="field-default" placeholder="ÈªòËÆ§ÂÄº">
                    </div>
                    <div class="property-item">
                        <label for="field-comment">Â≠óÊÆµÊ≥®Èáä</label>
                        <input type="text" id="field-comment" placeholder="Â≠óÊÆµÊ≥®Èáä">
                    </div>
                    <div class="property-item">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="field-primary">
                                <label for="field-primary">‰∏ªÈîÆ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="field-nullable" checked>
                                <label for="field-nullable">ÂÖÅËÆ∏‰∏∫Á©∫</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="field-unique">
                                <label for="field-unique">ÂîØ‰∏Ä</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="properties-actions">
                <div class="btn-group">
                    <button class="btn btn-full" id="add-field"><i class="fas fa-plus"></i> Ê∑ªÂä†Â≠óÊÆµ</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-full" id="update-field"><i class="fas fa-save"></i> Êõ¥Êñ∞Â≠óÊÆµ</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-danger btn-full" id="delete-field"><i class="fas fa-trash"></i> Âà†Èô§Â≠óÊÆµ</button>
                    <button class="btn btn-danger btn-full" id="delete-table"><i class="fas fa-trash"></i> Âà†Èô§Ë°®</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Áä∂ÊÄÅÊ†è -->
    <div class="status-bar" id="status-bar">
        Â∞±Áª™ - ÈÄâÊã©‰∏Ä‰∏™Ë°®ÂºÄÂßãÁºñËæë
    </div>
    
    <!-- JSONÁºñËæëÂô®Ê®°ÊÄÅÊ°Ü -->
    <div class="json-editor" id="json-editor">
        <div class="json-editor-content">
            <div class="json-editor-header">
                <h2>JSON ÁºñËæëÂô®</h2>
                <div>
                    <button class="btn" id="format-json"><i class="fas fa-align-left"></i> Ê†ºÂºèÂåñ</button>
                    <button class="btn" id="apply-json"><i class="fas fa-check"></i> Â∫îÁî®</button>
                    <button class="btn btn-danger" id="close-json"><i class="fas fa-times"></i> ÂÖ≥Èó≠</button>
                </div>
            </div>
            <div class="json-editor-body">
                <textarea class="json-editor-textarea" id="json-textarea"></textarea>
            </div>
            <div>
                <small>ÊèêÁ§∫: ÁºñËæëJSONÊï∞ÊçÆÂêéÁÇπÂáª"Â∫îÁî®"ÊåâÈíÆÁîüÊïàÔºåÁÇπÂáª"Ê†ºÂºèÂåñ"ÊåâÈíÆÁæéÂåñJSON</small>
            </div>
        </div>
    </div>
    
    <!-- SQLÁîüÊàêÂô®Ê®°ÊÄÅÊ°Ü -->
    <div class="sql-modal" id="sql-modal">
        <div class="sql-modal-content">
            <div class="sql-modal-header">
                <h2>ÁîüÊàêÁöÑSQL</h2>
                <div>
                    <button class="btn" id="copy-sql"><i class="fas fa-copy"></i> Â§çÂà∂SQL</button>
                    <button class="btn btn-success" id="execute-sql"><i class="fas fa-play"></i> ÊâßË°åSQL</button>
                    <button class="btn btn-danger" id="close-sql"><i class="fas fa-times"></i> ÂÖ≥Èó≠</button>
                </div>
            </div>
            <pre class="sql-modal-body" id="sql-output"></pre>
            <div>
                <small>ÊèêÁ§∫: SQLÂ∑≤ÁîüÊàêÔºåÁÇπÂáª"Â§çÂà∂SQL"ÊåâÈíÆÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºåÊàñÁÇπÂáª"ÊâßË°åSQL"Âú®Êï∞ÊçÆÂ∫ì‰∏≠ÊâßË°å</small>
            </div>
        </div>
    </div>

    <!-- ÈÄöÁü•ÂÆπÂô® -->
    <div id="notification-container"></div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let tables = [];
        let selectedTable = null;
        let selectedFieldIndex = -1;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let nextTableId = 1;
        
        // DOMÂÖÉÁ¥†
        const canvas = document.getElementById('canvas');
        const toolItems = document.querySelectorAll('.tool-item');
        const statusBar = document.getElementById('status-bar');
        
        // APIÂü∫Á°ÄURL
        const API_BASE = '';
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ËÆæÁΩÆÊãñÊãΩ‰∫ã‰ª∂
            setupDragAndDrop();
            
            // ËÆæÁΩÆÂ±ûÊÄßÈù¢Êùø‰∫ã‰ª∂
            setupPropertyPanel();
            
            // ËÆæÁΩÆËèúÂçï‰∫ã‰ª∂
            setupMenuEvents();
            
            // ËÆæÁΩÆÂèØÊäòÂè†Èù¢Êùø
            setupCollapsiblePanels();
            
            // Âä†ËΩΩÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑË°®
            loadTablesFromDatabase();
            
            updateStatusBar();
        });
        
        // ÊòæÁ§∫ÈÄöÁü•
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // APIËØ∑Ê±ÇÂ∞ÅË£Ö
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
                showNotification(`ËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩË°®
        async function loadTablesFromDatabase() {
            try {
                showNotification('Ê≠£Âú®Âä†ËΩΩË°®...', 'info');
                const data = await apiRequest(`${API_BASE}/api/tables`);
                
                if (data.success) {
                    // ËΩ¨Êç¢Êï∞ÊçÆÂ∫ìË°®ÁªìÊûÑ‰∏∫ÂâçÁ´ØÊ†ºÂºè
                    tables = data.tables.map(table => ({
                        id: `table-${nextTableId++}`,
                        name: table.name,
                        comment: '',
                        x: Math.random() * 500,
                        y: Math.random() * 300,
                        fields: table.columns.map(col => ({
                            name: col.name,
                            type: col.type,
                            length: '',
                            primary: col.primary_key,
                            nullable: col.nullable,
                            unique: false, // ÈúÄË¶Å‰ªéÁ¥¢Âºï‰ø°ÊÅØËé∑Âèñ
                            default: col.default_value || '',
                            comment: ''
                        }))
                    }));
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâË°®
                    canvas.innerHTML = '';
                    tables.forEach(table => renderTable(table));
                    
                    if (tables.length > 0) {
                        selectTable(tables[0]);
                        if (tables[0].fields.length > 0) {
                            selectField(tables[0], 0);
                        }
                    }
                    
                    showNotification(`ÊàêÂäüÂä†ËΩΩ ${tables.length} ‰∏™Ë°®`, 'success');
                }
            } catch (error) {
                console.error('Âä†ËΩΩË°®Â§±Ë¥•:', error);
                // Â¶ÇÊûúÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Á§∫‰æãÊï∞ÊçÆ
                addExampleTable();
            }
        }
        
        // ‰øùÂ≠òË°®Âà∞Êï∞ÊçÆÂ∫ì
        async function saveTableToDatabase(table) {
            try {
                showNotification('Ê≠£Âú®‰øùÂ≠òË°®...', 'info');
                
                const tableDesign = {
                    name: table.name,
                    comment: table.comment,
                    fields: table.fields.map(field => ({
                        name: field.name,
                        type: field.type,
                        length: field.length,
                        primary: field.primary,
                        nullable: field.nullable,
                        unique: field.unique,
                        default: field.default,
                        comment: field.comment
                    }))
                };
                
                const data = await apiRequest(`${API_BASE}/api/tables`, {
                    method: 'POST',
                    body: JSON.stringify({ table: tableDesign })
                });
                
                if (data.success) {
                    showNotification(`Ë°® ${table.name} ‰øùÂ≠òÊàêÂäü`, 'success');
                    return true;
                }
            } catch (error) {
                console.error('‰øùÂ≠òË°®Â§±Ë¥•:', error);
                return false;
            }
        }
        
        // Êõ¥Êñ∞Ë°®Âà∞Êï∞ÊçÆÂ∫ì
        async function updateTableInDatabase(table) {
            try {
                showNotification('Ê≠£Âú®Êõ¥Êñ∞Ë°®...', 'info');
                
                const tableDesign = {
                    name: table.name,
                    comment: table.comment,
                    fields: table.fields.map(field => ({
                        name: field.name,
                        type: field.type,
                        length: field.length,
                        primary: field.primary,
                        nullable: field.nullable,
                        unique: field.unique,
                        default: field.default,
                        comment: field.comment
                    }))
                };
                
                const data = await apiRequest(`${API_BASE}/api/tables/${table.name}`, {
                    method: 'PUT',
                    body: JSON.stringify({ table: tableDesign })
                });
                
                if (data.success) {
                    showNotification(`Ë°® ${table.name} Êõ¥Êñ∞ÊàêÂäü`, 'success');
                    return true;
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Ë°®Â§±Ë¥•:', error);
                return false;
            }
        }
        
        // Âà†Èô§Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑË°®
        async function deleteTableFromDatabase(tableName) {
            try {
                showNotification('Ê≠£Âú®Âà†Èô§Ë°®...', 'info');
                
                const data = await apiRequest(`${API_BASE}/api/tables/${tableName}`, {
                    method: 'DELETE'
                });
                
                if (data.success) {
                    showNotification(`Ë°® ${tableName} Âà†Èô§ÊàêÂäü`, 'success');
                    return true;
                }
            } catch (error) {
                console.error('Âà†Èô§Ë°®Â§±Ë¥•:', error);
                return false;
            }
        }
        
        // Ê∑ªÂä†Â≠óÊÆµÂà∞Êï∞ÊçÆÂ∫ìË°®
        async function addFieldToDatabase(tableName, field) {
            try {
                const data = await apiRequest(`${API_BASE}/api/tables/${tableName}/fields`, {
                    method: 'POST',
                    body: JSON.stringify({ field: field })
                });
                
                if (data.success) {
                    showNotification(`Â≠óÊÆµ ${field.name} Ê∑ªÂä†ÊàêÂäü`, 'success');
                    return true;
                }
            } catch (error) {
                console.error('Ê∑ªÂä†Â≠óÊÆµÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìË°®‰∏≠ÁöÑÂ≠óÊÆµ
        async function updateFieldInDatabase(tableName, fieldName, newField) {
            try {
                const data = await apiRequest(`${API_BASE}/api/tables/${tableName}/fields/${fieldName}`, {
                    method: 'PUT',
                    body: JSON.stringify({ field: newField })
                });
                
                if (data.success) {
                    showNotification(`Â≠óÊÆµ ${fieldName} Êõ¥Êñ∞ÊàêÂäü`, 'success');
                    return true;
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Â≠óÊÆµÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // Âà†Èô§Êï∞ÊçÆÂ∫ìË°®‰∏≠ÁöÑÂ≠óÊÆµ
        async function deleteFieldFromDatabase(tableName, fieldName) {
            try {
                const data = await apiRequest(`${API_BASE}/api/tables/${tableName}/fields/${fieldName}`, {
                    method: 'DELETE'
                });
                
                if (data.success) {
                    showNotification(`Â≠óÊÆµ ${fieldName} Âà†Èô§ÊàêÂäü`, 'success');
                    return true;
                }
            } catch (error) {
                console.error('Âà†Èô§Â≠óÊÆµÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // ËÆæÁΩÆÊãñÊãΩÂäüËÉΩ
        function setupDragAndDrop() {
            // Â∑•ÂÖ∑ÁÆ±ÊãñÊãΩ
            toolItems.forEach(item => {
                if (item.getAttribute('draggable') === 'true') {
                    item.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('text/plain', e.target.getAttribute('data-type'));
                    });
                }
            });
            
            // ÁîªÂ∏ÉÊé•Êî∂ÊãñÊãΩ
            canvas.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            canvas.addEventListener('drop', function(e) {
                e.preventDefault();
                const type = e.dataTransfer.getData('text/plain');
                
                if (type === 'table') {
                    createTable(e.clientX - canvas.getBoundingClientRect().left, 
                               e.clientY - canvas.getBoundingClientRect().top);
                }
            });
        }
        
        // ËÆæÁΩÆÂèØÊäòÂè†Èù¢Êùø
        function setupCollapsiblePanels() {
            const tableHeader = document.getElementById('table-properties-header');
            const tableContent = document.getElementById('table-properties-content');
            const fieldHeader = document.getElementById('field-properties-header');
            const fieldContent = document.getElementById('field-properties-content');
            
            // Ë°®Â±ûÊÄßÈù¢Êùø
            tableHeader.addEventListener('click', function() {
                const isCollapsed = tableHeader.classList.toggle('collapsed');
                tableContent.classList.toggle('collapsed', isCollapsed);
            });
            
            // Â≠óÊÆµÂ±ûÊÄßÈù¢Êùø
            fieldHeader.addEventListener('click', function() {
                const isCollapsed = fieldHeader.classList.toggle('collapsed');
                fieldContent.classList.toggle('collapsed', isCollapsed);
            });
        }
        
        // ÂàõÂª∫Êñ∞Ë°®
        function createTable(x, y) {
            const tableId = 'table-' + nextTableId++;
            const table = {
                id: tableId,
                name: 'new_table',
                comment: '',
                x: x,
                y: y,
                fields: [
                    { name: 'id', type: 'INTEGER', length: '', primary: true, nullable: false, unique: false, default: '', comment: '‰∏ªÈîÆID' }
                ]
            };
            
            tables.push(table);
            renderTable(table);
            selectTable(table);
            // Ëá™Âä®ÈÄâ‰∏≠Á¨¨‰∏Ä‰∏™Â≠óÊÆµ
            if (table.fields.length > 0) {
                selectField(table, 0);
            }
            updateStatusBar();
        }
        
        // Ê∏≤ÊüìË°®Âà∞ÁîªÂ∏É
        function renderTable(table) {
            // Â¶ÇÊûúË°®Â∑≤ÁªèÂ≠òÂú®ÔºåÂÖàÁßªÈô§
            const existingTable = document.getElementById(table.id);
            if (existingTable) {
                existingTable.remove();
            }
            
            // ÂàõÂª∫Ë°®ÂÖÉÁ¥†
            const tableElement = document.createElement('div');
            tableElement.id = table.id;
            tableElement.className = 'table';
            tableElement.style.left = table.x + 'px';
            tableElement.style.top = table.y + 'px';
            
            // Ë°®Â§¥
            const tableHeader = document.createElement('div');
            tableHeader.className = 'table-header';
            
            const tableName = document.createElement('span');
            tableName.textContent = table.name;
            
            const tableActions = document.createElement('div');
            tableActions.className = 'table-actions';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'table-action-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.title = 'Âà†Èô§Ë°®';
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                deleteTable(table);
            });
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'table-action-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.title = 'Â§çÂà∂Ë°®';
            copyBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                copyTable(table);
            });
            
            tableActions.appendChild(copyBtn);
            tableActions.appendChild(deleteBtn);
            
            tableHeader.appendChild(tableName);
            tableHeader.appendChild(tableActions);
            tableElement.appendChild(tableHeader);
            
            // Ë°®‰Ωì
            const tableBody = document.createElement('div');
            tableBody.className = 'table-body';
            
            table.fields.forEach((field, index) => {
                const row = document.createElement('div');
                row.className = 'table-row';
                if (selectedTable === table && selectedFieldIndex === index) {
                    row.classList.add('selected');
                }
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'field-name';
                nameSpan.textContent = field.name;
                
                const typeSpan = document.createElement('span');
                typeSpan.className = 'field-type';
                typeSpan.textContent = field.type + (field.length ? '(' + field.length + ')' : '');
                
                const fieldActions = document.createElement('div');
                fieldActions.className = 'field-actions';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'field-action-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Âà†Èô§Â≠óÊÆµ';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteField(table, index);
                });
                
                fieldActions.appendChild(deleteBtn);
                
                row.appendChild(nameSpan);
                row.appendChild(typeSpan);
                row.appendChild(fieldActions);
                tableBody.appendChild(row);
                
                // Ê∑ªÂä†Â≠óÊÆµÈÄâÊã©‰∫ã‰ª∂
                row.addEventListener('click', function(e) {
                    // Èò≤Ê≠¢ÁÇπÂáªÂà†Èô§ÊåâÈíÆÊó∂Ëß¶ÂèëÈÄâÊã©
                    if (e.target === deleteBtn || e.target.classList.contains('field-action-btn') || 
                        e.target.classList.contains('fa-trash')) {
                        return;
                    }
                    selectField(table, index);
                });
            });
            
            tableElement.appendChild(tableBody);
            
            // Ê∑ªÂä†ÊãñÊãΩ‰∫ã‰ª∂
            tableHeader.addEventListener('mousedown', startDrag);
            
            // Ê∑ªÂä†ÈÄâÊã©‰∫ã‰ª∂
            tableElement.addEventListener('mousedown', function(e) {
                if (e.target === tableHeader || e.target.closest('.table-actions')) return;
                selectTable(table);
            });
            
            canvas.appendChild(tableElement);
        }
        
        // ÂºÄÂßãÊãñÊãΩË°®
        function startDrag(e) {
            const tableElement = e.target.closest('.table');
            const table = tables.find(t => t.id === tableElement.id);
            
            if (table) {
                isDragging = true;
                selectedTable = table;
                
                // ËÆ°ÁÆóÈº†Ê†áÂú®Ë°®ÂÜÖÁöÑÂÅèÁßª
                dragOffset.x = e.clientX - table.x;
                dragOffset.y = e.clientY - table.y;
                
                document.addEventListener('mousemove', dragTable);
                document.addEventListener('mouseup', stopDrag);
            }
        }
        
        // ÊãñÊãΩË°®
        function dragTable(e) {
            if (!isDragging || !selectedTable) return;
            
            // ËÆ°ÁÆóÊñ∞‰ΩçÁΩÆ
            const newX = e.clientX - dragOffset.x;
            const newY = e.clientY - dragOffset.y;
            
            // Êõ¥Êñ∞Ë°®‰ΩçÁΩÆ
            selectedTable.x = newX;
            selectedTable.y = newY;
            
            // Êõ¥Êñ∞UI
            const tableElement = document.getElementById(selectedTable.id);
            tableElement.style.left = newX + 'px';
            tableElement.style.top = newY + 'px';
        }
        
        // ÂÅúÊ≠¢ÊãñÊãΩ
        function stopDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', dragTable);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        // ÈÄâÊã©Ë°®
        function selectTable(table) {
            selectedTable = table;
            selectedFieldIndex = -1;
            
            // Êõ¥Êñ∞Â±ûÊÄßÈù¢Êùø
            document.getElementById('table-name').value = table.name;
            document.getElementById('table-comment').value = table.comment || '';
            
            // Ê∏ÖÁ©∫Â≠óÊÆµË°®Âçï
            clearFieldForm();
            
            // È´ò‰∫ÆÊòæÁ§∫ÈÄâ‰∏≠ÁöÑË°®
            document.querySelectorAll('.table').forEach(t => {
                t.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
            });
            
            const selectedElement = document.getElementById(table.id);
            if (selectedElement) {
                selectedElement.style.boxShadow = '0 4px 15px rgba(52, 152, 219, 0.5)';
            }
            
            updateStatusBar();
        }
        
        // ÈÄâÊã©Â≠óÊÆµ
        function selectField(table, fieldIndex) {
            selectedTable = table;
            selectedFieldIndex = fieldIndex;
            
            const field = table.fields[fieldIndex];
            
            // Êõ¥Êñ∞Â≠óÊÆµË°®Âçï
            document.getElementById('field-name').value = field.name || '';
            document.getElementById('field-type').value = field.type || 'INTEGER';
            document.getElementById('field-length').value = field.length || '';
            document.getElementById('field-default').value = field.default || '';
            document.getElementById('field-comment').value = field.comment || '';
            
            // Á°Æ‰øùÂ§çÈÄâÊ°ÜÁä∂ÊÄÅÊ≠£Á°Æ
            document.getElementById('field-primary').checked = Boolean(field.primary);
            document.getElementById('field-nullable').checked = field.nullable !== false;
            document.getElementById('field-unique').checked = Boolean(field.unique);
            
            // È´ò‰∫ÆÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÂ≠óÊÆµ
            document.querySelectorAll('.table-row').forEach(row => {
                row.classList.remove('selected');
            });
            
            const tableElement = document.getElementById(table.id);
            if (tableElement) {
                const rows = tableElement.querySelectorAll('.table-row');
                if (rows[fieldIndex]) {
                    rows[fieldIndex].classList.add('selected');
                }
            }
            
            updateStatusBar();
        }
        
        // Ê∏ÖÁ©∫Â≠óÊÆµË°®Âçï
        function clearFieldForm() {
            document.getElementById('field-name').value = '';
            document.getElementById('field-type').value = 'INTEGER';
            document.getElementById('field-length').value = '';
            document.getElementById('field-primary').checked = false;
            document.getElementById('field-nullable').checked = true;
            document.getElementById('field-unique').checked = false;
            document.getElementById('field-default').value = '';
            document.getElementById('field-comment').value = '';
        }
        
        // ËÆæÁΩÆÂ±ûÊÄßÈù¢Êùø‰∫ã‰ª∂
        function setupPropertyPanel() {
            // Ë°®ÂêçÊõ¥Êñ∞
            document.getElementById('table-name').addEventListener('change', function() {
                if (selectedTable) {
                    selectedTable.name = this.value;
                    const tableHeader = document.querySelector(`#${selectedTable.id} .table-header span`);
                    if (tableHeader) {
                        tableHeader.textContent = this.value;
                    }
                    updateStatusBar();
                }
            });
            
            // Ë°®Ê≥®ÈáäÊõ¥Êñ∞
            document.getElementById('table-comment').addEventListener('change', function() {
                if (selectedTable) {
                    selectedTable.comment = this.value;
                }
            });
            
            // Â≠óÊÆµÂ±ûÊÄßÊõ¥Êñ∞
            const fieldInputs = [
                'field-name', 'field-type', 'field-length', 'field-default', 'field-comment',
                'field-primary', 'field-nullable', 'field-unique'
            ];
            
            fieldInputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('change', function() {
                    if (selectedTable && selectedFieldIndex >= 0) {
                        updateFieldFromForm();
                    }
                });
            });
            
            // Ê∑ªÂä†Â≠óÊÆµ
            document.getElementById('add-field').addEventListener('click', function() {
                if (selectedTable) {
                    const fieldName = document.getElementById('field-name').value || 'new_field';
                    const fieldType = document.getElementById('field-type').value;
                    const fieldLength = document.getElementById('field-length').value;
                    const isPrimary = document.getElementById('field-primary').checked;
                    const isNullable = document.getElementById('field-nullable').checked;
                    const isUnique = document.getElementById('field-unique').checked;
                    const defaultValue = document.getElementById('field-default').value;
                    const fieldComment = document.getElementById('field-comment').value;
                    
                    const newField = {
                        name: fieldName,
                        type: fieldType,
                        length: fieldLength,
                        primary: isPrimary,
                        nullable: isNullable,
                        unique: isUnique,
                        default: defaultValue,
                        comment: fieldComment
                    };
                    
                    selectedTable.fields.push(newField);
                    
                    renderTable(selectedTable);
                    // ÈÄâ‰∏≠Êñ∞Ê∑ªÂä†ÁöÑÂ≠óÊÆµ
                    selectField(selectedTable, selectedTable.fields.length - 1);
                    updateStatusBar();
                    
                    // ÂêåÊ≠•Âà∞Êï∞ÊçÆÂ∫ì
                    addFieldToDatabase(selectedTable.name, newField);
                }
            });
            
            // Êõ¥Êñ∞Â≠óÊÆµ
            document.getElementById('update-field').addEventListener('click', function() {
                if (selectedTable && selectedFieldIndex >= 0) {
                    updateFieldFromForm();
                }
            });
            
            // Âà†Èô§Â≠óÊÆµ
            document.getElementById('delete-field').addEventListener('click', function() {
                if (selectedTable && selectedFieldIndex >= 0) {
                    deleteField(selectedTable, selectedFieldIndex);
                }
            });
            
            // Âà†Èô§Ë°®
            document.getElementById('delete-table').addEventListener('click', function() {
                if (selectedTable) {
                    deleteTable(selectedTable);
                }
            });
            
            // ÂêåÊ≠•Ë°®Âà∞Êï∞ÊçÆÂ∫ì
            document.getElementById('sync-table').addEventListener('click', function() {
                if (selectedTable) {
                    syncTableToDatabase(selectedTable);
                }
            });
        }
        
        // ‰ªéË°®ÂçïÊõ¥Êñ∞Â≠óÊÆµ
        function updateFieldFromForm() {
            const fieldName = document.getElementById('field-name').value;
            const fieldType = document.getElementById('field-type').value;
            const fieldLength = document.getElementById('field-length').value;
            const isPrimary = document.getElementById('field-primary').checked;
            const isNullable = document.getElementById('field-nullable').checked;
            const isUnique = document.getElementById('field-unique').checked;
            const defaultValue = document.getElementById('field-default').value;
            const fieldComment = document.getElementById('field-comment').value;
            
            const oldFieldName = selectedTable.fields[selectedFieldIndex].name;
            const newField = {
                name: fieldName,
                type: fieldType,
                length: fieldLength,
                primary: isPrimary,
                nullable: isNullable,
                unique: isUnique,
                default: defaultValue,
                comment: fieldComment
            };
            
            selectedTable.fields[selectedFieldIndex] = newField;
            
            renderTable(selectedTable);
            // ÈáçÊñ∞ÈÄâÊã©ÂΩìÂâçÂ≠óÊÆµ‰ª•‰øùÊåÅÈÄâ‰∏≠Áä∂ÊÄÅ
            selectField(selectedTable, selectedFieldIndex);
            updateStatusBar();
            
            // ÂêåÊ≠•Âà∞Êï∞ÊçÆÂ∫ì
            updateFieldInDatabase(selectedTable.name, oldFieldName, newField);
        }
        
        // ÂêåÊ≠•Ë°®Âà∞Êï∞ÊçÆÂ∫ì
        async function syncTableToDatabase(table) {
            // Ê£ÄÊü•Ë°®ÊòØÂê¶Â∑≤Â≠òÂú®
            const tableExists = await checkTableExists(table.name);
            
            if (tableExists) {
                await updateTableInDatabase(table);
            } else {
                await saveTableToDatabase(table);
            }
        }
        
        // Ê£ÄÊü•Ë°®ÊòØÂê¶Â≠òÂú®
        async function checkTableExists(tableName) {
            try {
                const data = await apiRequest(`${API_BASE}/api/tables`);
                return data.tables.some(table => table.name === tableName);
            } catch (error) {
                return false;
            }
        }
        
        // ËÆæÁΩÆËèúÂçï‰∫ã‰ª∂
        function setupMenuEvents() {
            // Êñ∞Âª∫Ë°®ÊåâÈíÆ
            document.getElementById('btn-new-table').addEventListener('click', function() {
                createTable(100, 100);
            });
            
            // Ê∑ªÂä†Â≠óÊÆµÊåâÈíÆ
            document.getElementById('btn-add-field').addEventListener('click', function() {
                if (selectedTable) {
                    const fieldName = prompt('ËØ∑ËæìÂÖ•Â≠óÊÆµÂêç:', 'new_field');
                    if (fieldName) {
                        const newField = {
                            name: fieldName,
                            type: 'VARCHAR',
                            length: '255',
                            primary: false,
                            nullable: true,
                            unique: false,
                            default: '',
                            comment: ''
                        };
                        
                        selectedTable.fields.push(newField);
                        
                        renderTable(selectedTable);
                        // ÈÄâ‰∏≠Êñ∞Ê∑ªÂä†ÁöÑÂ≠óÊÆµ
                        selectField(selectedTable, selectedTable.fields.length - 1);
                        updateStatusBar();
                        
                        // ÂêåÊ≠•Âà∞Êï∞ÊçÆÂ∫ì
                        addFieldToDatabase(selectedTable.name, newField);
                    }
                } else {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë°®');
                }
            });
            
            // Â§çÂà∂Ë°®ÊåâÈíÆ
            document.getElementById('btn-copy-table').addEventListener('click', function() {
                if (selectedTable) {
                    copyTable(selectedTable);
                } else {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë°®');
                }
            });
            
            // JSONÁºñËæëÂô®ÊåâÈíÆ
            document.getElementById('btn-json-editor').addEventListener('click', function() {
                openJsonEditor();
            });
            
            // Â∫îÁî®JSON
            document.getElementById('apply-json').addEventListener('click', function() {
                applyJson();
            });
            
            // Ê†ºÂºèÂåñJSON
            document.getElementById('format-json').addEventListener('click', function() {
                formatJson();
            });
            
            // ÂÖ≥Èó≠JSONÁºñËæëÂô®
            document.getElementById('close-json').addEventListener('click', function() {
                document.getElementById('json-editor').style.display = 'none';
            });
            
            // ÂØºÂá∫JSON
            document.getElementById('export-json').addEventListener('click', function() {
                openJsonEditor();
            });
            
            // ÁîüÊàêSQL
            document.getElementById('generate-sql').addEventListener('click', function() {
                generateSql();
            });
            
            // Â§çÂà∂SQL
            document.getElementById('copy-sql').addEventListener('click', function() {
                copySqlToClipboard();
            });
            
            // ÊâßË°åSQL
            document.getElementById('execute-sql').addEventListener('click', function() {
                executeSql();
            });
            
            // ÂÖ≥Èó≠SQLÊ®°ÊÄÅÊ°Ü
            document.getElementById('close-sql').addEventListener('click', function() {
                document.getElementById('sql-modal').style.display = 'none';
            });
            
            // Âä†ËΩΩË°®ÊåâÈíÆ
            document.getElementById('load-tables').addEventListener('click', function() {
                loadTablesFromDatabase();
            });
            
            // ‰øùÂ≠òË°®ÊåâÈíÆ
            document.getElementById('save-table').addEventListener('click', function() {
                if (selectedTable) {
                    syncTableToDatabase(selectedTable);
                } else {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë°®');
                }
            });
        }
        
        // ÊâìÂºÄJSONÁºñËæëÂô®
        function openJsonEditor() {
            const jsonTextarea = document.getElementById('json-textarea');
            const jsonData = {
                tables: tables,
                nextTableId: nextTableId
            };
            
            // Ê†ºÂºèÂåñJSON
            const formattedJson = JSON.stringify(jsonData, null, 2);
            jsonTextarea.value = formattedJson;
            
            document.getElementById('json-editor').style.display = 'flex';
        }
        
        // Ê†ºÂºèÂåñJSON
        function formatJson() {
            const jsonTextarea = document.getElementById('json-textarea');
            try {
                const jsonData = JSON.parse(jsonTextarea.value);
                const formattedJson = JSON.stringify(jsonData, null, 2);
                jsonTextarea.value = formattedJson;
            } catch (e) {
                alert('JSONÊ†ºÂºèÈîôËØØÔºåÊó†Ê≥ïÊ†ºÂºèÂåñ: ' + e.message);
            }
        }
        
        // Â∫îÁî®JSON
        function applyJson() {
            const jsonTextarea = document.getElementById('json-textarea');
            try {
                const jsonData = JSON.parse(jsonTextarea.value);
                
                if (jsonData.tables) {
                    tables = jsonData.tables;
                    nextTableId = jsonData.nextTableId || nextTableId;
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâË°®
                    canvas.innerHTML = '';
                    tables.forEach(table => renderTable(table));
                    
                    // ÈáçÁΩÆÈÄâÊã©
                    selectedTable = null;
                    selectedFieldIndex = -1;
                    clearFieldForm();
                    
                    updateStatusBar();
                    
                    document.getElementById('json-editor').style.display = 'none';
                    showNotification('JSONÊï∞ÊçÆÂ∫îÁî®ÊàêÂäü', 'success');
                } else {
                    alert('JSONÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÁº∫Â∞ëtablesÂ±ûÊÄß');
                }
            } catch (e) {
                alert('JSONÊ†ºÂºèÈîôËØØ: ' + e.message);
            }
        }
        
        // ÁîüÊàêSQL
        function generateSql() {
            if (tables.length === 0) {
                alert('Ê≤°ÊúâË°®ÂèØ‰ª•ÁîüÊàêSQL');
                return;
            }
            
            let sql = '';
            
            tables.forEach(table => {
                sql += `-- ÂàõÂª∫Ë°®: ${table.name}\n`;
                sql += `-- Ê≥®Èáä: ${table.comment || 'Êó†'}\n`;
                sql += `CREATE TABLE ${table.name} (\n`;
                
                table.fields.forEach((field, index) => {
                    sql += `  ${field.name} ${field.type}`;
                    
                    if (field.length) {
                        sql += `(${field.length})`;
                    }
                    
                    if (field.primary) {
                        sql += ' PRIMARY KEY';
                    }
                    
                    if (!field.nullable) {
                        sql += ' NOT NULL';
                    }
                    
                    if (field.unique) {
                        sql += ' UNIQUE';
                    }
                    
                    if (field.default) {
                        sql += ` DEFAULT ${field.default}`;
                    }
                    
                    if (field.comment) {
                        sql += ` COMMENT '${field.comment}'`;
                    }
                    
                    if (index < table.fields.length - 1) {
                        sql += ',';
                    }
                    
                    sql += '\n';
                });
                
                sql += ');\n\n';
            });
            
            // Â∫îÁî®SQLËØ≠Ê≥ïÈ´ò‰∫Æ
            const sqlOutput = document.getElementById('sql-output');
            sqlOutput.innerHTML = sqlSyntaxHighlight(sql);
            
            document.getElementById('sql-modal').style.display = 'flex';
        }
        
        // ÊâßË°åSQL
        async function executeSql() {
            const sqlOutput = document.getElementById('sql-output');
            const sql = sqlOutput.textContent;
            
            if (!sql.trim()) {
                alert('Ê≤°ÊúâSQLÂèØÊâßË°å');
                return;
            }
            
            try {
                showNotification('Ê≠£Âú®ÊâßË°åSQL...', 'info');
                const data = await apiRequest(`${API_BASE}/api/execute-sql`, {
                    method: 'POST',
                    body: JSON.stringify({ sql: sql })
                });
                
                if (data.success) {
                    if (data.results) {
                        // ÊòæÁ§∫Êü•ËØ¢ÁªìÊûú
                        let resultHtml = '<h3>Êü•ËØ¢ÁªìÊûú:</h3>';
                        resultHtml += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                        
                        // Ë°®Â§¥
                        resultHtml += '<tr>';
                        data.columns.forEach(col => {
                            resultHtml += `<th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5;">${col}</th>`;
                        });
                        resultHtml += '</tr>';
                        
                        // Êï∞ÊçÆË°å
                        data.results.forEach(row => {
                            resultHtml += '<tr>';
                            data.columns.forEach(col => {
                                resultHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${row[col] || ''}</td>`;
                            });
                            resultHtml += '</tr>';
                        });
                        
                        resultHtml += '</table>';
                        sqlOutput.innerHTML += '\n\n' + resultHtml;
                    } else {
                        showNotification(`SQLÊâßË°åÊàêÂäüÔºåÂΩ±Âìç ${data.rows_affected} Ë°å`, 'success');
                    }
                }
            } catch (error) {
                console.error('ÊâßË°åSQLÂ§±Ë¥•:', error);
            }
        }
        
        // Â§çÂà∂SQLÂà∞Ââ™Ë¥¥Êùø
        function copySqlToClipboard() {
            const sqlOutput = document.getElementById('sql-output');
            const text = sqlOutput.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                showNotification('SQLÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            }, function(err) {
                console.error('Â§çÂà∂Â§±Ë¥•: ', err);
                alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
            });
        }
        
        // Âà†Èô§Ë°®
        async function deleteTable(table) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ë°® "${table.name}" ÂêóÔºü`)) {
                // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§
                const success = await deleteTableFromDatabase(table.name);
                
                if (success) {
                    // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§
                    const index = tables.indexOf(table);
                    if (index > -1) {
                        tables.splice(index, 1);
                    }
                    
                    // ‰ªéDOM‰∏≠ÁßªÈô§
                    const tableElement = document.getElementById(table.id);
                    if (tableElement) {
                        tableElement.remove();
                    }
                    
                    // ÈáçÁΩÆÈÄâÊã©
                    if (selectedTable === table) {
                        selectedTable = null;
                        selectedFieldIndex = -1;
                        clearFieldForm();
                    }
                    
                    updateStatusBar();
                }
            }
        }
        
        // Â§çÂà∂Ë°®
        function copyTable(table) {
            const newTable = JSON.parse(JSON.stringify(table));
            newTable.id = 'table-' + nextTableId++;
            newTable.name = table.name + '_copy';
            newTable.x = table.x + 30;
            newTable.y = table.y + 30;
            
            tables.push(newTable);
            renderTable(newTable);
            selectTable(newTable);
            updateStatusBar();
        }
        
        // Âà†Èô§Â≠óÊÆµ
        async function deleteField(table, fieldIndex) {
            const fieldName = table.fields[fieldIndex].name;
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Â≠óÊÆµ "${fieldName}" ÂêóÔºü`)) {
                // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§
                const success = await deleteFieldFromDatabase(table.name, fieldName);
                
                if (success) {
                    table.fields.splice(fieldIndex, 1);
                    
                    // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ≠óÊÆµÔºåÈáçÁΩÆÈÄâÊã©
                    if (selectedTable === table && selectedFieldIndex === fieldIndex) {
                        selectedFieldIndex = -1;
                        clearFieldForm();
                    }
                    
                    renderTable(table);
                    updateStatusBar();
                }
            }
        }
        
        // Êõ¥Êñ∞Áä∂ÊÄÅÊ†è
        function updateStatusBar() {
            if (selectedTable) {
                if (selectedFieldIndex >= 0) {
                    const field = selectedTable.fields[selectedFieldIndex];
                    statusBar.textContent = `Ë°®: ${selectedTable.name} | Â≠óÊÆµ: ${field.name} (${field.type})`;
                } else {
                    statusBar.textContent = `Ë°®: ${selectedTable.name} | Â≠óÊÆµÊï∞: ${selectedTable.fields.length}`;
                }
            } else {
                statusBar.textContent = `Â∞±Áª™ - Ë°®Êï∞Èáè: ${tables.length}`;
            }
        }
        
        // Ê∑ªÂä†Á§∫‰æãË°®
        function addExampleTable() {
            const userTable = {
                id: 'table-1',
                name: 'users',
                comment: 'Áî®Êà∑Ë°®',
                x: 50,
                y: 50,
                fields: [
                    { name: 'id', type: 'INTEGER', length: '', primary: true, nullable: false, unique: true, default: '', comment: 'Áî®Êà∑ID' },
                    { name: 'username', type: 'VARCHAR', length: '50', primary: false, nullable: false, unique: true, default: '', comment: 'Áî®Êà∑Âêç' },
                    { name: 'email', type: 'VARCHAR', length: '100', primary: false, nullable: false, unique: true, default: '', comment: 'ÈÇÆÁÆ±' },
                    { name: 'password', type: 'VARCHAR', length: '255', primary: false, nullable: false, unique: false, default: '', comment: 'ÂØÜÁ†Å' },
                    { name: 'created_at', type: 'DATETIME', length: '', primary: false, nullable: false, unique: false, default: 'CURRENT_TIMESTAMP', comment: 'ÂàõÂª∫Êó∂Èó¥' }
                ]
            };
            
            tables.push(userTable);
            nextTableId = 2;
            
            renderTable(userTable);
            selectTable(userTable);
            selectField(userTable, 0);
        }
        
        // SQLËØ≠Ê≥ïÈ´ò‰∫Æ
        function sqlSyntaxHighlight(sql) {
            // ÂÖ≥ÈîÆÂ≠ó
            const keywords = [
                'CREATE', 'TABLE', 'PRIMARY', 'KEY', 'NOT', 'NULL', 'UNIQUE', 'DEFAULT', 'COMMENT'
            ];
            
            let highlighted = sql;
            
            // È´ò‰∫ÆÂÖ≥ÈîÆÂ≠ó
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                highlighted = highlighted.replace(regex, `<span class="sql-keyword">${keyword}</span>`);
            });
            
            // È´ò‰∫ÆË°®Âêç (Âú®CREATE TABLE‰πãÂêé)
            highlighted = highlighted.replace(/CREATE TABLE (\w+)/g, 'CREATE TABLE <span class="sql-table">$1</span>');
            
            // È´ò‰∫ÆÂ≠óÊÆµÂêç (ÊØèË°åÂºÄÂßã)
            highlighted = highlighted.replace(/^\s*(\w+)/gm, '<span class="sql-field">$1</span>');
            
            // È´ò‰∫ÆÊï∞ÊçÆÁ±ªÂûã
            const types = ['INTEGER', 'VARCHAR', 'TEXT', 'DATETIME', 'DATE', 'TIME', 'BOOLEAN', 'DECIMAL', 'FLOAT', 'DOUBLE', 'BLOB', 'JSON'];
            types.forEach(type => {
                const regex = new RegExp(`\\b${type}\\b`, 'gi');
                highlighted = highlighted.replace(regex, `<span class="sql-type">${type}</span>`);
            });
            
            // È´ò‰∫ÆÊ≥®Èáä
            highlighted = highlighted.replace(/--.*$/gm, '<span class="sql-comment">$&</span>');
            
            return highlighted;
        }
    </script>
</body>
</html>